# 架构设计

## 概述

Stardewl-Ink 是一个星露谷物语联机工具，使用 WebRTC 实现 P2P 连接，无需端口转发。本文档描述系统的整体架构。

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      客户端应用程序                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Windows   │  │    macOS    │  │    Linux    │        │
│  │   (WinUI3)  │  │  (SwiftUI)  │  │   (GTK4)    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ 使用核心库 (C ABI)
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                       核心库 (Go)                           │
│  ┌─────────────────────────────────────────────────────┐  │
│  │                  WebRTC 连接管理                    │  │
│  │  • 连接建立与维护                                  │  │
│  │  • 数据通道通信                                    │  │
│  │  • ICE 候选交换                                    │  │
│  └─────────────────────────────────────────────────────┘  │
│  ┌─────────────────────────────────────────────────────┐  │
│  │                  Mod 文件管理                       │  │
│  │  • 文件扫描与哈希计算                              │  │
│  │  • Mod 对比与差异分析                              │  │
│  │  • 跨平台路径处理                                  │  │
│  └─────────────────────────────────────────────────────┘  │
│  ┌─────────────────────────────────────────────────────┐  │
│  │                   消息协议                          │  │
│  │  • JSON 消息序列化                                 │  │
│  │  • 心跳检测                                        │  │
│  │  • 错误处理                                        │  │
│  └─────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ WebSocket 信令
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    信令服务器 (Go)                          │
│  ┌─────────────────────────────────────────────────────┐  │
│  │                WebSocket 连接管理                   │  │
│  │  • 房间管理 (连接码)                               │  │
│  │  • SDP/ICE 消息转发                                │  │
│  │  • 心跳与连接保活                                  │  │
│  └─────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. 信令服务器 (`signaling/`)

**职责**:
- 管理 WebSocket 连接
- 处理连接码的生成和验证
- 转发 SDP Offer/Answer 和 ICE 候选
- 心跳检测和连接保活

**技术栈**:
- Go + gorilla/websocket
- HTTP/WebSocket 服务器

### 2. 核心库 (`core/`)

**职责**:
- WebRTC 连接建立和维护
- Mod 文件扫描和对比
- 消息协议序列化/反序列化
- 跨平台文件路径处理

**主要模块**:
- `connection.go`: WebRTC 连接管理
- `mods.go`: Mod 文件处理
- `messages.go`: 消息协议定义
- `core.go`: 客户端主逻辑

**技术栈**:
- Go + pion/webrtc
- 标准库文件操作

### 3. 客户端应用程序

**各平台实现**:

#### Windows
- **框架**: WinUI 3 或 WPF
- **职责**: 原生 Windows 界面，调用核心库 C ABI

#### macOS
- **框架**: SwiftUI
- **职责**: 原生 macOS 界面，调用核心库 C ABI

#### Linux
- **框架**: GTK 4 或 Qt
- **职责**: 原生 Linux 界面，调用核心库 C ABI

## 通信流程

### 1. 连接建立流程

```
主机 (Host)                         信令服务器                        客户端 (Client)
    │                                   │                                   │
    │ 1. 生成连接码                     │                                   │
    │ ────────────────────────────────► │                                   │
    │                                   │                                   │
    │ 2. 连接码显示给用户               │                                   │
    │                                   │                                   │
    │                                   │                                   │ 3. 用户输入连接码
    │                                   │ ◄───────────────────────────────── │
    │                                   │                                   │
    │ 4. WebSocket 连接                 │                                   │ 5. WebSocket 连接
    │ ────────────────────────────────► │ ◄───────────────────────────────── │
    │                                   │                                   │
    │ 6. 创建 SDP Offer                 │                                   │
    │ ────────────────────────────────► │                                   │
    │                                   │ 7. 转发 Offer                     │
    │                                   │ ──────────────────────────────────► │
    │                                   │                                   │
    │                                   │                                   │ 8. 创建 SDP Answer
    │                                   │ ◄───────────────────────────────── │
    │ 9. 接收 Answer                    │                                   │
    │ ◄──────────────────────────────── │                                   │
    │                                   │                                   │
    │ 10. ICE 候选交换                  │                                   │ 11. ICE 候选交换
    │ ────────────────────────────────► │ ◄───────────────────────────────── │
    │ ◄──────────────────────────────── │ ──────────────────────────────────► │
    │                                   │                                   │
    │ 12. WebRTC 连接建立               │                                   │ 13. WebRTC 连接建立
```

### 2. Mod 检查流程

```
主机 (Host)                         客户端 (Client)
    │                                   │
    │ 1. 连接建立成功                   │
    │                                   │
    │ 2. 扫描本地 Mods                  │ 3. 扫描本地 Mods
    │                                   │
    │ 4. 发送 Mod 列表                  │
    │ ─────────────────────────────────► │
    │                                   │
    │                                   │ 5. 对比 Mods
    │                                   │
    │ 6. 接收对比结果                   │
    │ ◄──────────────────────────────── │
    │                                   │
    │ 7. 显示差异给用户                 │ 8. 显示差异给用户
```

## 数据流

### 1. 信令消息

```json
// SDP Offer
{
  "type": "offer",
  "data": {
    "connection_id": "123456",
    "sdp": "v=0\r\no=- 123456 2 IN IP4 127.0.0.1\r\n..."
  }
}

// ICE 候选
{
  "type": "ice_candidate",
  "data": {
    "connection_id": "123456",
    "candidate": "candidate:1 1 UDP 2130706431 192.168.1.100 12345 typ host"
  }
}
```

### 2. 应用消息

```json
// Mod 列表
{
  "type": "mods_list",
  "payload": {
    "mods": [
      {
        "name": "StardewValleyExpanded",
        "checksum": "a1b2c3d4...",
        "size": 10485760
      }
    ]
  }
}

// Mod 对比结果
{
  "type": "mods_comparison",
  "payload": {
    "comparison": {
      "only_in_local": [...],
      "only_in_remote": [...],
      "different": [...],
      "same": [...]
    }
  }
}
```

## 错误处理

### 1. 连接错误
- WebSocket 连接失败
- WebRTC 连接失败
- ICE 协商失败

### 2. 文件错误
- Mods 路径不存在
- 文件读取权限问题
- 哈希计算失败

### 3. 协议错误
- 消息格式错误
- 消息类型未知
- 序列化/反序列化失败

## 扩展性考虑

### 1. 未来功能
- 文件传输（Mod 同步）
- 语音聊天
- 游戏状态同步
- 多房间支持

### 2. 性能优化
- 增量 Mod 扫描
- 连接池管理
- 消息压缩
- 二进制协议替代 JSON

### 3. 安全性增强
- TLS/SSL 加密
- 连接码加密
- 身份验证
- 速率限制